name: å°é»‘ç›’æ¯æ—¥ç­¾åˆ°

on:
  schedule:
    # æ¯å¤©æ—©ä¸Š8ç‚¹æ‰§è¡Œ (UTCæ—¶é—´0ç‚¹ = åŒ—äº¬æ—¶é—´8ç‚¹)
    - cron: '0 0 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  sign:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Node.jsç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: ç¼“å­˜ä¾èµ–
      uses: actions/cache@v4
      with:
        path: ~/.npm
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-
          
    - name: å®‰è£…ä¾èµ–
      run: |
        npm init -y
        npm install axios
        
    - name: åˆ›å»ºç­¾åˆ°è„šæœ¬
      run: |
        cat > sign.js << 'EOF'
        const axios = require('axios');
        const fs = require('fs');
        const path = require('path');
        
        // è·å–å½“å‰æ—¥æœŸ
        function getDate() {
          const now = new Date();
          return `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}`;
        }
        
        // Serveré…±æ¨é€
        async function serverchanNotify(title, content) {
          const SERVERCHAN_KEY = process.env.SERVERCHAN_KEY;
          if (!SERVERCHAN_KEY) return;
          
          console.log("å‡†å¤‡é€šè¿‡Serveré…±å‘é€é€šçŸ¥...");
          
          try {
            const result = await axios.post(`https://sctapi.ftqq.com/${SERVERCHAN_KEY}.send`, {
              title: title,
              desp: content
            });
            
            console.log("Serveré…±æ¨é€æˆåŠŸ");
            console.log(`çŠ¶æ€ç : ${result.status}, å“åº”: ${JSON.stringify(result.data)}`);
            return true;
          } catch (error) {
            console.error("Serveré…±æ¨é€å¤±è´¥:", error.message);
            return false;
          }
        }
        
        // ä½¿ç”¨æœ€æ–°APIè·¯å¾„çš„å°é»‘ç›’ç­¾åˆ°å‡½æ•°
        async function signIn() {
          try {
            console.log(`å¼€å§‹å°é»‘ç›’ç­¾åˆ°ä»»åŠ¡ - ${new Date().toLocaleString('zh-CN')}`);
            
            // è·å–ç¯å¢ƒå˜é‡
            const cookie = process.env.BLACKBOX_COOKIE;
            
            if (!cookie) {
              throw new Error("æœªè®¾ç½®BLACKBOX_COOKIEç¯å¢ƒå˜é‡");
            }
            
            // åˆ†å‰²å¤šä¸ªè´¦å·
            const accounts = cookie.split('&');
            console.log(`æ£€æµ‹åˆ° ${accounts.length} ä¸ªè´¦å·`);
            
            let results = [];
            
            for (const account of accounts) {
              const [heyboxId, cookies] = account.split('#');
              
              console.log(`æ­£åœ¨ç­¾åˆ°è´¦å·: ${heyboxId}`);
              
              try {
                // ä½¿ç”¨æ­£ç¡®çš„ç­¾åˆ°APIè·¯å¾„
                const result = await axios.post(
                  'https://api.xiaoheihe.cn/account/sign_in/', 
                  {}, 
                  {
                    headers: {
                      'Cookie': cookies,
                      'User-Agent': 'Mozilla/5.0 (iPhone; CPU iPhone OS 17_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/15E148'
                    }
                  }
                );
                
                // è§£æè¿”å›ç»“æœ
                if (result.data && result.data.code === 0) {
                  console.log(`ç­¾åˆ°æˆåŠŸ: ${JSON.stringify(result.data)}`);
                  results.push({
                    account: heyboxId,
                    status: 'æˆåŠŸ',
                    message: result.data.message || 'ç­¾åˆ°æˆåŠŸ'
                  });
                } else {
                  results.push({
                    account: heyboxId,
                    status: 'å¤±è´¥',
                    message: result.data?.msg || `æœåŠ¡å™¨è¿”å›: ${result.status}`
                  });
                }
              } catch (error) {
                console.error(`è´¦å· ${heyboxId} è¯·æ±‚å¤±è´¥: ${error.message}`);
                results.push({
                  account: heyboxId,
                  status: 'è¯·æ±‚å¤±è´¥',
                  message: error.message
                });
              }
            }
            
            // æ„é€ é€šçŸ¥å†…å®¹
            const dateStr = getDate();
            const title = `å°é»‘ç›’ç­¾åˆ°ç»“æœ - ${dateStr}`;
            
            let content = `## ç­¾åˆ°ç»“æœ (${dateStr})\n\n`;
            content += results.map(r => `ğŸ”¹ **è´¦å· ${r.account}**: ${r.status}\nğŸ’¬ ${r.message}`).join('\n\n');
            content += `\n\n> æ‰§è¡Œæ—¶é—´: ${new Date().toLocaleString('zh-CN')}`;
            
            // å‘é€Serveré…±é€šçŸ¥
            await serverchanNotify(title, content);
            
            return { success: true, results };
            
          } catch (error) {
            console.error("ç­¾åˆ°ä¸»æµç¨‹é”™è¯¯:", error.message);
            
            // å‘é€é”™è¯¯é€šçŸ¥
            await serverchanNotify(
              "å°é»‘ç›’ç­¾åˆ°å‡ºé”™", 
              `é”™è¯¯ä¿¡æ¯: ${error.message}\næ—¶é—´: ${new Date().toLocaleString('zh-CN')}`
            );
            
            throw error; // æŠ›å‡ºé”™è¯¯ä½¿å·¥ä½œæµå¤±è´¥
          }
        }
        
        // ä¸»å‡½æ•°
        (async () => {
          try {
            const signResult = await signIn();
            console.log("ç­¾åˆ°ä»»åŠ¡å®Œæˆ:", signResult.success ? "æˆåŠŸ" : "å¤±è´¥");
            process.exit(signResult.success ? 0 : 1);
          } catch (error) {
            console.error("ç­¾åˆ°ä»»åŠ¡æ‰§è¡Œå¤±è´¥", error);
            process.exit(1);
          }
        })();
        EOF
        
    - name: è¿è¡Œç­¾åˆ°è„šæœ¬
      env:
        BLACKBOX_COOKIE: ${{ secrets.BLACKBOX_COOKIE }}  # ä½¿ç”¨æ‚¨ä¹‹å‰æå–çš„cookie
        SERVERCHAN_KEY: ${{ secrets.SERVERCHAN_KEY }}     # Serveré…±æ¨é€KEY
      run: |
        node sign.js
        
    - name: ä¸Šä¼ æ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: sign-logs
        path: |
          sign.js  # åŒ…å«æ—¥å¿—çš„è¾“å‡ºæ–‡ä»¶
        retention-days: 7
