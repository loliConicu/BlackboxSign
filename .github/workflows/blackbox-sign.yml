name: 小黑盒每日签到

on:
  schedule:
    # 每天早上8点执行 (UTC时间，北京时间需要减8小时)
    - cron: '0 0 * * *'
  workflow_dispatch:  # 允许手动触发
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  sign:
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      
    - name: 设置Node.js环境
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: 缓存依赖
      uses: actions/cache@v4
      with:
        path: ~/.npm
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-
          
    - name: 安装依赖
      run: |
        if [ -f package.json ]; then
          npm install
        else
          # 如果没有package.json，安装常见的签到脚本依赖
          npm install axios cheerio crypto-js
        fi
        
    - name: 运行签到脚本
      env:
        # 从GitHub Secrets中获取敏感信息
        BLACKBOX_USERNAME: ${{ secrets.BLACKBOX_USERNAME }}
        BLACKBOX_PASSWORD: ${{ secrets.BLACKBOX_PASSWORD }}
        BLACKBOX_TOKEN: ${{ secrets.BLACKBOX_TOKEN }}
        # 小黑盒相关环境变量
        BLACKBOX_COOKIE: ${{ secrets.BLACKBOX_COOKIE }}
        BLACKBOX_USERID: ${{ secrets.BLACKBOX_USERID }}
        BLACKBOX_SESSDATA: ${{ secrets.BLACKBOX_SESSDATA }}
        # 推送相关配置 - 仅添加Server酱Key
        SERVERCHAN_KEY: ${{ secrets.SERVERCHAN_KEY }}
        # 原有推送配置保持不变
        PUSH_KEY: ${{ secrets.PUSH_KEY }}
        BARK_PUSH: ${{ secrets.BARK_PUSH }}
        TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
        TG_USER_ID: ${{ secrets.TG_USER_ID }}
        DD_BOT_TOKEN: ${{ secrets.DD_BOT_TOKEN }}
        DD_BOT_SECRET: ${{ secrets.DD_BOT_SECRET }}
        QYWX_WEBHOOK: ${{ secrets.QYWX_WEBHOOK }}
        # 其他可能需要的环境变量
        SCKEY: ${{ secrets.SCKEY }}
        SENDKEY: ${{ secrets.SENDKEY }}
        # 青龙面板相关
        QL_URL: ${{ secrets.QL_URL }}
        QL_CLIENT_ID: ${{ secrets.QL_CLIENT_ID }}
        QL_CLIENT_SECRET: ${{ secrets.QL_CLIENT_SECRET }}
        # 设置默认值防止undefined错误
        NODE_ENV: production
        TZ: Asia/Shanghai
      run: |
        # 检查关键环境变量
        echo "检查环境变量..."
        if [ -z "$BLACKBOX_USERNAME" ] && [ -z "$BLACKBOX_COOKIE" ]; then
          echo "⚠️  警告: 未设置 BLACKBOX_USERNAME 或 BLACKBOX_COOKIE"
          echo "请在 GitHub Secrets 中添加必要的认证信息"
        fi
        
        # 检查Server酱Key
        if [ -n "$SERVERCHAN_KEY" ]; then
          echo "⚠️  注意: Server酱推送功能已启用"
        fi
        
        # 根据项目结构调整主脚本文件名
        if [ -f "BlackBoxSign.js" ]; then
          echo "执行 BlackBoxSign.js..."
          node BlackBoxSign.js || echo "❌ 脚本执行失败，退出码: $?"
        elif [ -f "main.js" ]; then
          echo "执行 main.js..."
          node main.js || echo "❌ 脚本执行失败，退出码: $?"
        elif [ -f "sign.js" ]; then
          echo "执行 sign.js..."
          node sign.js || echo "❌ 脚本执行失败，退出码: $?"
        elif [ -f "blackbox.js" ]; then
          echo "执行 blackbox.js..."
          node blackbox.js || echo "❌ 脚本执行失败，退出码: $?"
        elif [ -f "run.js" ]; then
          echo "执行 run.js..."
          node run.js || echo "❌ 脚本执行失败，退出码: $?"
        elif [ -f "index.js" ]; then
          echo "执行 index.js..."
          node index.js || echo "❌ 脚本执行失败，退出码: $?"
        else
          echo "未找到主执行文件，请检查项目结构"
          ls -la
        fi
        
    - name: 上传日志
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: sign-logs
        path: |
          *.log
          logs/
          log/
        retention-days: 7
